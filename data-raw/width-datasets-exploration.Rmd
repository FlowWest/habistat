---
title: "Width Datasets"
author: "Maddee Rubenson (FlowWest)"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
library(sf)
library(tidyverse)

# googledrive::drive_auth()
 
theme_set(theme_minimal())

source('data-functions.R')

project_crs <- "ESRI:102039"

knitr::opts_chunk$set(echo = TRUE)

```

## River Channel Width Dataset Exploration

### Global River Width Database

* http://hydro.iis.u-tokyo.ac.jp/~yamadai/GWD-LR/
* downloadable link here:https://zenodo.org/records/1269595

```{r include=FALSE}

watersheds <-
  drive_file_by_id("1ncwKAUNoJUNkPLEy6NzrUKCYqVG681p-", vsizip=T) |>
  st_read() |>
  janitor::clean_names() |>
  st_transform(project_crs) |>
  st_union()

```

```{r eval=FALSE, include=FALSE}
# this script finds which datasets overlap with the Central Valley
files <- list.files('../../../../Downloads/GRWL_centerlineData/')

files_cali <- data.frame(
  file_name = files,
  number = str_extract(files, "\\d{2}(?=\\.)"),
  extension = substring(files, nchar(files) - 3, nchar(files))
  ) |>
  filter(number %in% c(10, 11)) |>
  filter(extension == ".shp")

for(i in 1:length(files_cali$file_name)) {

  dataset <- read_sf(paste0('../../../../Downloads/GRWL_centerlineData/', files_cali$file_name[i])) |>
    st_transform(project_crs)

  ggplot() +
    geom_sf(data = watersheds) +
    geom_sf(data = dataset, aes(color = 'GRWL dataset')) +
    ggtitle(files_cali$file_name[i])

  ggsave(filename = paste0('plots/', files_cali$file_name[i], '.png'),  plot = last_plot())
}

```

#### Vector files that overlap with the Central Valley

```{r}
nk10 <- drive_file_by_id('1H-oAmip5Pp2H0sQJnGRT_srypQGy8dWE', vsizip=T) |>
  st_read()

nj10 <- drive_file_by_id('1xq-0uoJbCA5fQE38OsOK1mi9k3boXsmF', vsizip = T) |> 
  st_read()

all_width_data_in_cv <- nk10 |> 
  bind_rows(nj10) |> 
  janitor::clean_names() |> 
  filter(lake_flag == 0) |> 
  mutate(width_feet = width_m * 3.28084) |> 
  glimpse()

# ggplot(all_width_data_in_cv, aes(x = width_feet)) +
#   geom_histogram(bins = 100)

summary(all_width_data_in_cv$width_feet)

all_width_data_in_cv_trunc <- all_width_data_in_cv |> 
  filter(width_feet < 354) #3rd quantile 

ggplot(all_width_data_in_cv_trunc, aes(x = width_feet)) +
  geom_histogram()

ggplot() +
    geom_sf(data = watersheds) +
    geom_sf(data = all_width_data_in_cv_trunc, aes(color = width_feet))


saveRDS(all_width_data_in_cv_trunc, 'width_data/global_width_dataset.RDS')

```

### Merit Hydro

Data source: https://hydro.iis.u-tokyo.ac.jp/~yamadai/MERIT_Hydro/

River width is reprepared in 4-byte float (float32), in meter. The values larger than 0 represents the river width at the channel centerlines. The value "-1" represents non-centerline water pixels, and the value "0" corresponds to the non-water pixels.

The undefined pixels (oceans) are represented by the value -9999.
River channel width is calculated by the method described in [Yamazaki et al. 2012, WRR], with some improvements/changes on the algorithm.


```{r}
library(stars)
library(sf)

flowlines <- readRDS("../data/flowline_geometries.Rds") |>
  left_join(readRDS("../data/flowline_attributes.Rds")) |>
  st_transform(project_crs)

merit_1 <- drive_file_by_id('17vpwVL4HYa74-VrXkewWvWg2YUjyqVfC', vsizip = F) |>
  raster::raster() |> 
  st_as_stars() |> 
  st_as_sf(merge = TRUE) |> 
  st_cast("MULTILINESTRING") |> 
  st_transform(project_crs) |> 
  rename(width_m = n40w125_wth) |> 
  filter(width_m > 0)

merit_2 <- drive_file_by_id('10D-q6xHkVNqqqGVS98XpGYVrn2oqFDAi', vsizip = F) |>
  raster::raster() |> 
  st_as_stars() |> 
  st_as_sf(merge = TRUE) |> 
  st_cast("MULTILINESTRING") |> 
  st_transform(project_crs) |> 
  rename(width_m = n35w125_wth) |> 
  filter(width_m > 0)

merit_3 <- drive_file_by_id('1EU8qVDJy-UXfehkxgXXNbM1x5AJpxrpu', vsizip = F) |>
  raster::raster() |> 
  st_as_stars() |> 
  st_as_sf(merge = TRUE) |> 
  st_cast("MULTILINESTRING") |> 
  st_transform(project_crs) |> 
  rename(width_m = n30w125_wth) |> 
  filter(width_m > 0)

all_merit <- bind_rows(merit_1, merit_2, merit_3) |> 
  mutate(width_feet = width_m * 3.28084) 

summary(all_merit)

# filter by third quartile

all_merit_trunc <- all_merit |> 
  filter(width_m <= 165.43)

ggplot() + 
  geom_sf(data = watersheds) +
  geom_sf(data = all_merit_trunc, aes(color = width_feet))

ggplot() +
  geom_histogram(data = all_merit_trunc, aes(x = width_feet))

saveRDS(all_merit_trunc, 'width_data/merit_width_data.RDS')

```

