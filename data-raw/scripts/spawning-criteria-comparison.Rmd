---
title: "Spawning Habitat Suitability Criteria"
author: "[Maddee Rubenson](mailto:mrubenson@flowwest.com)"
date: "`r Sys.Date()`"
output: 
  github_document:
    toc: true
    toc_depth: 3
    number_sections: false
    math_method:
      engine: webtex
      url: https://latex.codecogs.com/svg.image?
---

```{r setup, include=FALSE}
library(tidyverse)

theme_set(theme_minimal())

```

## Habitat Suitability Criteria 

## Objective 

Develop a habitat suitability criteria that can be used across watersheds within the HabiStat model.

## Methods 

### Read in data 

Data is from various sources and was compiled by Mark Gard for use in CVPIA DSMHabitat. Within the dataset are spawning criteria for depth, velocity, and substrate for 11 watersheds and Fall, Late Fall, Winter, Spring for Chinook Salmon.

```{r}
hsc_raw <- readxl::read_excel(here::here('data-raw', 'source', 'hsc', 'HSC.xlsx'), sheet = "flat") |> 
  janitor::clean_names() |> 
  glimpse()

spawning_hsc <- hsc_raw |> 
  filter(life_stage == "Spawning")


spawning_table <- hsc_raw |> 
  filter(life_stage == "Spawning",
         species == "Chinook") |>
  select(river, race, suitability_metric, citation) |> 
  mutate(suitability_metric = paste0(unique(suitability_metric), collapse = "; ")) |> 
  distinct() 

knitr::kable(spawning_table, caption = "All habitat suitability criteria compiled by Mark Gard")

```

### Depth HSI

```{r message=FALSE, warning=FALSE}
spawning_hsc |> 
  filter(suitability_metric == "Depth") |> 
  filter(units_si < 3,
         species == "Chinook") |>   
  ggplot() + 
  geom_point(aes(x = units_si, y = suitability_index, color = paste0(river, " (", citation, ")"))) + 
  geom_line(aes(x = units_si, y = suitability_index, color = paste0(river, " (", citation, ")"))) + 
  facet_wrap(~race, scales = "free_x") + 
  xlab('depth (meters)') + 
  theme(legend.title=element_blank()) + 
  facet_wrap(~ race)

# Take max across all reaches
spawning_hsc |> 
  filter(suitability_metric == "Depth") |> 
  filter(units_si < 3,
         species == "Chinook") |>   
  mutate(units_si = round(units_si, 1)) |> 
  group_by(units_si, race) |> 
  summarise(max_suit_index = max(suitability_index)) |> 
  ggplot() + 
  geom_line(aes(x = units_si, y = max_suit_index, color = race), size = 1) + 
  xlab('depth (meters)') + 
  ylab('suitability index') 

spawning_hsc |> 
  filter(suitability_metric == "Depth") |> 
  filter(units_si < 3,
         species == "Chinook") |>   
  mutate(units_si = round(units_si, 1)) |> 
  group_by(units_si) |> 
  summarise(max_suit_index = max(suitability_index)) |> 
  ggplot() + 
  geom_line(aes(x = units_si, y = max_suit_index), size = 1) + 
  xlab('depth (meters)') + 
  ylab('suitability index') 


```

### Velocity HSI

```{r message=FALSE, warning=FALSE}
spawning_hsc |> 
  filter(suitability_metric == "Velocity") |> 
  filter(units_si < 30,
         species == "Chinook") |>   
  ggplot() + 
  geom_point(aes(x = units_si, y = suitability_index, color = paste0(river, " (", citation, ")"))) + 
  geom_line(aes(x = units_si, y = suitability_index, color = paste0(river, " (", citation, ")"))) + 
  facet_wrap(~race, scales = "free_x") + 
  xlab('velocity (meters/second)') + 
  theme(legend.title=element_blank())

# Take max
spawning_hsc |> 
  filter(suitability_metric == "Velocity") |> 
  filter(units_si < 30,
         species == "Chinook") |>   
  mutate(units_si = round(units_si, 1)) |> 
  group_by(units_si, race) |> 
  summarise(max_suit_index = max(suitability_index)) |> 
  ggplot() + 
  geom_line(aes(x = units_si, y = max_suit_index, color = race), size = 1) + 
  xlab('velocity (meters/second)')  + 
  ylab('suitability index')

spawning_hsc |> 
  filter(suitability_metric == "Velocity") |> 
  filter(units_si < 30,
         species == "Chinook") |>   
  mutate(units_si = round(units_si, 1)) |> 
  group_by(units_si) |> 
  summarise(max_suit_index = max(suitability_index)) |> 
  ggplot() + 
  geom_line(aes(x = units_si, y = max_suit_index), size = 1) + 
  xlab('velocity (meters/second)')  + 
  ylab('suitability index')

```


