---
title: "SWC Habitat Model Data Discovery"
author: "[Skyler Lewis](mailto:slewis@flowwest.com)"
date: "`r Sys.Date()`"
output: 
  github_document:
    toc: true
    toc_depth: 3
    number_sections: false
    math_method:
      engine: webtex
      url: https://latex.codecogs.com/svg.image?
  html_document:
    toc: true
    toc_depth: 3
    number_sections: false
    math_method:
      engine: webtex
      url: https://latex.codecogs.com/svg.image?
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(sf)
library(stars)

theme_set(theme_minimal())

#project_crs <- "EPSG:3310" # NAD83 California Teale Albers
#project_crs <- "EPSG:5070" # NAD83 CONUS Albers
project_crs <- "ESRI:102039" # NAD83 CONUS Albers USGS Version
```

*Selected HUCs*

* Lower Yuba 18020107
* Upper Yuba 18020125

*Data Source*

* NHDPlusV2 dataset https://nhdplus.com/NHDPlus/NHDPlusV2_home.php
* As retrievedfrom https://www.epa.gov/waterdata/nhdplus-california-data-vector-processing-unit-18
* User Guide https://www.epa.gov/system/files/documents/2023-04/NHDPlusV2_User_Guide.pdf
* (This is different from [NHDPlusHR](https://pubs.usgs.gov/of/2019/1096/ofr20191096.pdf) which is generated at a higher resolution and more computationally intensive)

*Supplemental Data*

* Upstream catchment characteristics: Wieczorek, M.E., Jackson, S.E., and Schwarz, G.E., 2018, Select Attributes for NHDPlus Version 2.1 Reach Catchments and Modified Network Routed Upstream Watersheds for the Conterminous United States (ver. 4.0, August 2023): U.S. Geological Survey data release, https://doi.org/10.5066/F7765D7V https://www.sciencebase.gov/catalog/item/57976a0ce4b021cadec97890

Potential sources of channel widths

* Simplest version: https://digitalcommons.unl.edu/usdaarsfacpub/1515
as available in dataset: Schwarz, G. E., Jackson, S. E., & Wieczorek, M. E. (2018). Select Attributes for NHDPlus Version 2.1 Reach Catchments and Modified Network Routed Upstream Watersheds for the Conterminous United States (ver. 4.0, August 2023) [Data set]. U.S. Geological Survey. https://doi.org/10.5066/F7765D7V https://data.usgs.gov/datacatalog/data/USGS:5cf02bdae4b0b51330e22b85

* More complex modelled dataset: https://doi.org/10.1111/1752-1688.13116

* Best: empirical data

## Data Import

## Import HUC Watersheds

```{r}
selected_huc_8 <- c("18020107", "18020125")

# HUC-12 watersheds and higher level heirarchies
watersheds <- st_read("nhdplus/WBD_Subwatershed.shp") |> 
  janitor::clean_names() |>
  filter(huc_8 %in% selected_huc_8) |>
  st_transform(project_crs)

watersheds |> ggplot() + geom_sf()
```

### Import Supplemental Tables

```{r message=FALSE, warning=FALSE}
if(!file.exists("flowline_attributes.Rds")) {
  
      # fcode table
  fcodes <- 
    foreign::read.dbf("nhdplus/NHDFCode.dbf") |> 
    as_tibble() |> 
    janitor::clean_names() |>
    rename(fcode = f_code, fcode_desc = descriptio) |>
    mutate(ftype_desc = map(fcode_desc, function(x) str_split(x, ":", simplify=TRUE)[1])) |>
    unnest(ftype_desc) |>
    select(fcode, ftype_desc)
  
  # flowline shapefile attribute table
  flowline_table <- 
    foreign::read.dbf("nhdplus/Hydrography/NHDFlowline.dbf") |> 
    janitor::clean_names() |>
    select(comid, reachcode, gnis_id, gnis_name, lengthkm, ftype, fcode) |>
    mutate(huc_8 = substr(reachcode, 1, 8),
           huc_10 = substr(reachcode, 1, 10),
           huc_12 = substr(reachcode, 1, 12)) |>
    inner_join(fcodes |> select(fcode, ftype_desc))

  # # cumulative upstream area
  # flowline_cumarea <- 
  #   foreign::read.dbf("nhdplus/NHDPlusAttributes/CumulativeArea.dbf") |> 
  #   as_tibble() |> 
  #   janitor::clean_names() |>
  #   rename(comid = com_id)
  
  # flow routing attributes as described in https://www.usgs.gov/national-hydrography/value-added-attributes-vaas
  flowline_vaattr <- 
    foreign::read.dbf("nhdplus/NHDPlusAttributes/PlusFlowlineVAA.dbf") |> 
    as_tibble() |> 
    select(comid = ComID, 
           hydro_seq = Hydroseq,
           reach_code = ReachCode,
           stream_level = StreamLeve, 
           stream_order = StreamOrde, 
           us_length_km = ArbolateSu,
           ds_length_km = Pathlength,
           da_area_sq_km = DivDASqKM, # using divergence-routed version 
           #da_area_sq_km_tot = TotDASqKM,
           reach_length_km = LengthKM
           )
  
  # slopes and endpoint elevations
  flowline_slopes <- 
    foreign::read.dbf("nhdplus/NHDPlusAttributes/elevslope.dbf") |> 
    as_tibble() |> 
    mutate(slope = if_else(SLOPE==-9998, NA, SLOPE),
           elev_min = MINELEVSMO/100, # convert from cm to m
           elev_max = MAXELEVSMO/100) |>
    select(comid = COMID, slope, elev_min, elev_max)
  
  # # identifiers of each flowline (COMID)
  # flowline_comid_huc_crosswalk <- 
  #   foreign::read.dbf("nhdplus/NHDReachCode_Comid.dbf") |> 
  #   as_tibble() |> 
  #   janitor::clean_names() |>
  #   mutate(huc_8 = substr(reachcode, 1, 8),
  #          huc_10 = substr(reachcode, 1, 10),
  #          huc_12 = substr(reachcode, 1, 12)) |>
  #   filter(huc_8 %in% selected_huc_8) |>
  #   select(comid, huc_8, huc_10, huc_12)
  
  # vogel method mean annual flow and mean annual velocity
  vogel_flow <- 
    foreign::read.dbf("nhdplus/VogelExtension/vogelflow.dbf") |> 
    as_tibble() |>
    janitor::clean_names() |>
    mutate(across(maflowv:mavelv, function(x) if_else(x>=0, x, NA))) |>
    select(comid, vogel_q_ma_cfs = maflowv, vogel_v_ma_fps = mavelv)
  
    # incremental precipitation at reach
  loc_precip_annual <- 
    read_delim("nhdplus/VPUAttributeExtension/IncrPrecipMA.txt") |>
    mutate(comid = as.numeric(FeatureID), loc_ppt_mean_mm = PrecipV/100) |>
    select(comid, loc_ppt_mean_mm)
  import_loc_precip <- function(m) {
    mm <- str_pad(m, width=2, pad="0")
    read_delim(paste0("nhdplus/VPUAttributeExtension/IncrPrecipMM", mm, ".txt")) |>
      mutate(month = m) |>
      mutate(comid = as.numeric(FeatureID), loc_ppt_mean_mm = PrecipV/100) |>
      select(month, comid, loc_ppt_mean_mm)
  }
  loc_precip_monthly <- 
    seq(1,12,1) |> 
    map(import_loc_precip) |> 
    reduce(bind_rows) |>
    pivot_wider(names_from = month, names_prefix = "loc_ppt_mean_mm_", values_from = loc_ppt_mean_mm)

  # cumulative precipitation in upstream drainage area
  precip_annual <- 
    read_delim("nhdplus/VPUAttributeExtension/CumTotPrecipMA.txt") |>
    mutate(comid = as.numeric(ComID), da_ppt_mean_mm = PrecipVC/100) |>
    select(comid, da_ppt_mean_mm)
  import_precip <- function(m) {
    mm <- str_pad(m, width=2, pad="0")
    read_delim(paste0("nhdplus/VPUAttributeExtension/CumTotPrecipMM", mm, ".txt")) |>
      mutate(month = m) |>
      mutate(comid = as.numeric(ComID), da_ppt_mean_mm = PrecipVC/100) |>
      select(month, comid, da_ppt_mean_mm)
  }
  precip_monthly <- 
    seq(1,12,1) |> 
    map(import_precip) |> 
    reduce(bind_rows) |>
    pivot_wider(names_from = month, names_prefix = "da_ppt_mean_mm_", values_from = da_ppt_mean_mm)
  
  # EROM method mean annual and monthly flows
  erom_annual <- 
    foreign::read.dbf(paste0("nhdplus/EROMExtension/EROM_MA0001.dbf")) |>
    as_tibble() |>
    select(comid = ComID, erom_q_ma_cfs = Q0001E, erom_v_ma_fps = V0001E, 
           #temp = Temp0001, ppt = PPT0001, pet = PET0001, qetloss = QLoss0001,
           #catchment_lat = Lat, catchment_sqkm = AreaSqKm,
           ) |>
    mutate(across(erom_q_ma_cfs:erom_v_ma_fps, function(x) if_else(x>=0, x, NA)))
  import_erom <- function(m) {
    mm <- str_pad(m, width=2, pad="0")
    foreign::read.dbf(paste0("nhdplus/EROMExtension/EROM_", mm, "0001.dbf")) |>
      as_tibble() |>
      mutate(month = m) |>
      select(month, comid = ComID, erom_q_ma_cfs = Q0001E, erom_v_ma_fps = V0001E, 
             #temp = Temp0001, ppt = PPT0001, pet = PET0001, qetloss = QLoss0001,
             #catchment_lat = Lat, catchment_sqkm = AreaSqKm,
             ) |> 
      mutate(across(erom_q_ma_cfs:erom_v_ma_fps, function(x) if_else(x>=0, x, NA)))
  }
  erom_monthly <- 
    seq(1,12,1) |> 
    map(import_erom) |> 
    reduce(bind_rows)
  erom_monthly_flows <- erom_monthly |> pivot_wider(names_from = month, names_prefix = "erom_q_ma_cfs_", values_from = erom_q_ma_cfs)
erom_monthly_velocities <- erom_monthly |> pivot_wider(names_from = month, names_prefix = "erom_v_ma_fps_", values_from = erom_v_ma_fps)
  
  # sinuosity from https://www.sciencebase.gov/catalog/item/57976a0ce4b021cadec97890
  flowline_sinuosity <- 
    read_delim("nhdplus_extension/Sinuousity_CONUS.TXT") |>
    janitor::clean_names() |>
    filter(comid %in% flowline_vaattr$comid)
  
  # catchment characteristics from https://www.sciencebase.gov/catalog/item/57976a0ce4b021cadec97890
  da_suppl_attrs <- # using divergence routed version
    read_delim("nhdplus_extension/BASIN_CHAR_ACC_CONUS.TXT") |>
    filter(COMID %in% flowline_vaattr$comid) |>
    select(comid = COMID, 
           da_avg_slope = ACC_BASIN_SLOPE, 
           da_elev_mean = ACC_ELEV_MEAN,
           da_elev_min = ACC_ELEV_MIN,
           da_elev_max = ACC_ELEV_MAX) |>
    mutate(da_elev_rel = da_elev_max - da_elev_min)
  
  flowline_attributes <-
    flowline_table |>
    left_join(flowline_vaattr) |> 
    left_join(flowline_slopes) |>
    mutate(stream_power = slope * da_area_sq_km) |>
    left_join(precip_annual) |>
    left_join(loc_precip_annual) |>
    left_join(vogel_flow) |>
    left_join(erom_annual) |>
    left_join(flowline_sinuosity) |>
    left_join(da_suppl_attrs)
  
  flowline_attributes |> saveRDS("flowline_attributes.Rds")
  
} else {
  
  flowline_attributes <- readRDS("flowline_attributes.Rds")
  
}

```


```{r}

```

### Import flowline geometry

```{r}
flowlines <- 
  st_read("nhdplus/Hydrography/NHDFlowline.shp") |>
  janitor::clean_names() |>
  select(comid) |>
  inner_join(flowline_attributes) |>
  filter(huc_8 %in% selected_huc_8) |>
  arrange(hydro_seq) |>
  st_transform(project_crs)

#flowareas <- 
#  st_read("nhdplus/Hydrography/NHDArea.shp") |>
#  janitor::clean_names() |>
#  arrange(comid) #|>
#  #inner_join(flowlines |> st_drop_geometry() |> select(comid)) |>
#  #select(comid, ftype, fcode, geometry)

waterbodies <- 
  st_read("nhdplus/Hydrography/NHDWaterbody.shp") |>
  janitor::clean_names() |>
  mutate(huc_8 = substr(reachcode, 1, 8),
         huc_10 = substr(reachcode, 1, 10),
         huc_12 = substr(reachcode, 1, 12)) |>
  filter(huc_8 %in% selected_huc_8) |>
  arrange(comid) |>
  st_transform(project_crs)
```

### Plots of attribute data

```{r}
# plot showing slopes
flowlines |> 
  st_zm() |>
  filter(gnis_name %in% c("Yuba River", "South Yuba River", "Middle Yuba River", "North Yuba River")) |>
  ggplot() + 
  geom_sf(data=st_zm(flowlines), aes(color = slope)) +
  geom_sf(aes(color = slope), linewidth=1) + 
  geom_sf(data=waterbodies, fill="gray", color="gray") +
  scale_color_viridis_c(trans = "log")

```

```{r}
# plot showing drainage area
flowlines |> 
  st_zm() |>
  filter(gnis_name %in% c("Yuba River", "South Yuba River", "Middle Yuba River", "North Yuba River")) |>
  ggplot() + 
  geom_sf(data=st_zm(flowlines), aes(color = da_area_sq_km)) +
  geom_sf(aes(color = da_area_sq_km), linewidth=1) + 
  geom_sf(data=waterbodies, fill="gray", color="gray") +
  scale_color_viridis_c(direction=-1)
```

```{r}
# plot showing stream order
flowlines |> 
  st_zm() |>
  filter(gnis_name %in% c("Yuba River", "South Yuba River", "Middle Yuba River", "North Yuba River")) |>
  ggplot() + 
  geom_sf(data=st_zm(flowlines), aes(color = stream_order)) +
  geom_sf(aes(color = stream_order), linewidth=1) + 
  geom_sf(data=waterbodies, fill="gray", color="gray") +
  scale_color_viridis_c(direction=-1)
```

```{r}
# plot showing mean annual precip at local reach location
flowlines |> 
  st_zm() |>
  filter(gnis_name %in% c("Yuba River", "South Yuba River", "Middle Yuba River", "North Yuba River")) |>
  ggplot() + 
  geom_sf(data=st_zm(flowlines), aes(color = loc_ppt_mean_mm)) +
  geom_sf(aes(color = loc_ppt_mean_mm), linewidth=1) + 
  geom_sf(data=waterbodies, fill="gray", color="gray") +
  scale_color_viridis_c(direction=-1)
```

```{r}
# plot showing mean annual precip in upstream drainage area
flowlines |> 
  st_zm() |>
  filter(gnis_name %in% c("Yuba River", "South Yuba River", "Middle Yuba River", "North Yuba River")) |>
  ggplot() + 
  geom_sf(data=st_zm(flowlines), aes(color = da_ppt_mean_mm)) +
  geom_sf(aes(color = da_ppt_mean_mm), linewidth=1) + 
  geom_sf(data=waterbodies, fill="gray", color="gray") +
  scale_color_viridis_c(direction=-1)
```

```{r}
# plot showing mean elevation of upstream drainage area
flowlines |> 
  st_zm() |>
  filter(gnis_name %in% c("Yuba River", "South Yuba River", "Middle Yuba River", "North Yuba River")) |>
  ggplot() + 
  geom_sf(data=st_zm(flowlines), aes(color = da_elev_mean)) +
  geom_sf(aes(color = da_elev_mean), linewidth=1) + 
  geom_sf(data=waterbodies, fill="gray", color="gray") +
  scale_color_viridis_c(direction=-1)
```

```{r}
# plot showing EROM flow estimates
flowlines |> 
  st_zm() |>
  filter(gnis_name %in% c("Yuba River", "South Yuba River", "Middle Yuba River", "North Yuba River")) |>
  ggplot() + 
  geom_sf(data=st_zm(flowlines), aes(color = erom_q_ma_cfs)) +
  geom_sf(aes(color = erom_q_ma_cfs), linewidth=1) + 
  geom_sf(data=waterbodies, fill="gray", color="gray") +
  scale_color_viridis_c(direction=-1)
```

```{r}
# plot showing EROM velocity estimates
flowlines |> 
  st_zm() |>
  filter(gnis_name %in% c("Yuba River", "South Yuba River", "Middle Yuba River", "North Yuba River")) |>
  ggplot() + 
  geom_sf(data=st_zm(flowlines), aes(color = erom_v_ma_fps)) +
  geom_sf(aes(color = erom_v_ma_fps), linewidth=1) + 
  geom_sf(data=waterbodies, fill="gray", color="gray") +
  scale_color_viridis_c(direction=-1)
```

```{r}
# plot showing sinuousity estimates
flowlines |> 
  st_zm() |>
  filter(gnis_name %in% c("Yuba River", "South Yuba River", "Middle Yuba River", "North Yuba River")) |>
  ggplot() + 
  geom_sf(data=st_zm(flowlines), aes(color = sinuosity)) +
  geom_sf(aes(color = sinuosity), linewidth=1) + 
  geom_sf(data=waterbodies, fill="gray", color="gray") +
  scale_color_viridis_c(direction=-1)
```

### Import catchments

```{r}
# local catchment associated with each flowline reach (COMID)
catchments <- 
  st_read("nhdplus/Catchment.shp") |> 
  janitor::clean_names() |>
  mutate(comid = as.numeric(featureid)) |>
  inner_join(flowlines |> st_drop_geometry() |> select(comid)) |>
  arrange(comid) |>
  st_transform(project_crs) 

# examples
ggplot() + geom_sf(data = catchments, color="orange") + 
  geom_sf(data = watersheds, color="red", fill=NA) + 
  geom_sf(data = st_zm(flowlines), color="blue") 
```



## Stream Widths?

#### Points along line

using st_line_sample or st_segmentize

```{r}
# approach with one point every 100 ft
sample_points_100ft <- 
  flowlines |> 
  filter(gnis_name %in% c("Yuba River", "South Yuba River", "Middle Yuba River", "North Yuba River")) |>
  st_line_sample(density = 1 / 100) 

# approach with just the midpoint of each segment
sample_points_midpt <- 
  flowlines |>
  filter(gnis_name %in% c("Yuba River", "South Yuba River", "Middle Yuba River", "North Yuba River")) |>
  #st_line_sample(sample = c(0, 0.25, 0.5, 0.75, 1))
  st_line_sample(sample = c(0.5))

sample_points_midpt |> ggplot() + geom_sf()
```

```{r}
cvpia_extents <- st_read("habitat_extents_cvpia/habitat_extents_combined_gradients_v3.shp")

cvpia_extents |> 
  st_cast("LINESTRING") |>
  mutate(geometry = st_line_sample(geometry, sample = c(0,1))) |>
  ggplot() + geom_sf()
```

## DEM 

### 10m NHDPlusHR

```{r}
dem <- read_stars("nhdplushr/dem_nhdplushr_yuba_meters_v2.tif")
# this input has already been clipped to the AOI, converted from cm to m, and crs redefined
ggplot() + geom_stars(data=dem) + coord_fixed()
```

#### export flowlines within this raster domain

```{r}
flowlines_for_vbet <- flowlines |>
  filter(gnis_name %in% c("Yuba River")) |>
  st_transform(st_crs(dem)) |>
  st_zm() |> 
  st_crop(st_bbox(dem)) |>
  smoothr::densify(5)

#flowlines_for_vbet |>
#  st_write("out/flowlines_for_vbet.shp", append=FALSE)

flowlines_for_vbet |> ggplot() + geom_sf(aes(color = tot_da_sq_km)) #+ geom_stars(data=dem)
```

### 1m CA NoCAL Wildfires B2 2018

Not generalizable/automatable

https://rockyweb.usgs.gov/vdelivery/Datasets/Staged/Elevation/LPC/Projects/CA_NoCAL_3DEP_Supp_Funding_2018_D18/CA_NoCAL_Wildfires_B2_2018/

https://prd-tnm.s3.amazonaws.com/index.html?prefix=StagedProducts/Elevation/OPR/Projects/CA_NoCAL_Wildfires_B2_2018

https://prd-tnm.s3.amazonaws.com/index.html?prefix=StagedProducts/Elevation/metadata/CA_NoCAL_3DEP_Supp_Funding_2018_D18/CA_NoCAL_Wildfires_B2_2018

## Vegetation

```{r}
naip_filename <- "naip/naip.tif"

naip_proxy <-  read_stars(naip_filename, proxy = TRUE)
 
naip_ndvi <- function(x) (x[4]-x[1]) / (x[4]+x[1])

ndvi_out <- st_apply(naip_proxy, c("x", "y"), ndvi)


```
