---
title: "Hydraulic Training Data"
output: github_document
---

```{r setup, message=FALSE, warning=FALSE}
library(tidyverse)
library(sf)
library(stars)
library(terra)
```

Define habitat suitability functions

Source: 1029_Yuba_Flow_Effects_Modeling_Task_1_2022-09-30_reduced.pdf

```{r funcs}
# simple linear interpolation function
linterp <- function(x, x1, x2, y1, y2){
  y1 + ((x-x1)/(x2-x1)) * (y2-y1)
}

# vectorized function to calculate the depth*velocity suitability factor
# if applicable, cover will also need to be applied.
# method=0 uses simple 1/0 thresholds (CVPIA)
# method=1 uses ranges defined in CBEC Lower Yuba River report, tables 8-9
# method=2 uses ranges defined for USBR San Joaquin model (which also did not incorporate cover)
dvhsi <- function(d, v, method=0) {
  
  if(method==0){
    
    return(if_else(d>0.5 & d<=5.2 & v>0.1 & v<=4.0, 1, 0))
    
  } else if(method==1){
    
    dhsi <- case_when(
      d<=0.5 ~ 0,
      d<=0.9 ~ linterp(d, 0.5, 0.9, 0, 1),
      d<=4.0 ~ 1,
      d<=5.2 ~ linterp(d, 4.0, 5.2, 1, 0),
      d>5.2 ~ 0)
    vhsi <- case_when(
      v<=0.1 ~ linterp(v, 0.0, 0.1, 0, 1),
      v<=0.8 ~ 1,
      v<=1.8 ~ linterp(v, 0.8, 1.8, 1, 0.35),
      v<=4.0 ~ linterp(v, 1.8, 4.0, 0.35, 0),
      v>4.0 ~ 0)
    return(sqrt(dhsi*vhsi))
    
  } else if(method==3){
    
    dhsi <- case_when(d<=0.01 ~ 0.00,
                      d<=0.10 ~ 0.10,
                      d<=0.20 ~ 0.20,
                      d<=0.60 ~ 0.15,
                      d<=0.80 ~ 0.35,
                      d<=1.00 ~ 0.46,
                      d<=1.20 ~ 0.53,
                      d<=1.50 ~ 0.64,
                      d<=2.10 ~ 0.86,
                      d<=2.50 ~ 0.86,
                      d<=2.90 ~ 0.57,
                      d<=4.00 ~ 0.34,
                      d<=4.50 ~ 0.14,
                      d<=5.00 ~ 0.30,
                      d<=7.00 ~ 0.20,
                      d<=7.10 ~ 0.10,
                      d<=10.0 ~ 0.00,
                      d>10.0 ~ 0.00)
    vhsi <- case_when(v<=0.1 ~ 0.94,
                      v<=0.2 ~ 0.98,
                      v<=0.3 ~ 1.00,
                      v<=0.5 ~ 0.99,
                      v<=0.7 ~ 0.98,
                      v<=1.0 ~ 0.96,
                      v<=1.2 ~ 0.95,
                      v<=1.5 ~ 0.93,
                      v<=2.0 ~ 0.68,
                      v<=2.5 ~ 0.30,
                      v<=2.8 ~ 0.08,
                      v<=3.4 ~ 0.01,
                      v<=3.5 ~ 0.01,
                      v>3.5 ~ 0.00)
    return(pmin(dhsi, vhsi))
    
  }
}
```

## Stanislaus

Import SRH2D model data for Stanislaus (unlike HEC-RAS, the SRH2D outputs are natively vector format)

```{r stan-import, message=FALSE, warning=FALSE}
# SRH2D model domain, dissolved from SRH2D mesh faces using QGIS
stan_domain <- st_read("/vsizip/hydraulic_model_data/stanislaus_srh2d_2013/StanMesh072313_Domain.shp.zip", as_tibble=T)

# SRH2D model domain, manually split into polygons aligning with COMID segments
stan_comid <- st_read("/vsizip/hydraulic_model_data/stanislaus_srh2d_2013/StanMesh072313_Domain_COMID.shp.zip", as_tibble=T) |>
  st_zm() |> janitor::clean_names()

# SRH2D mesh vertices, converted from 2DM using QGIS 
stan_vertices <- st_read("/vsizip/hydraulic_model_data/stanislaus_srh2d_2013/StanMesh072313_Vertices.shp.zip", as_tibble=T) |>
  mutate(vid = row_number()) |>
  select(vid)

# Thiessen (aka Voronoi) polygons for mesh vertices, generated using QGIS
stan_thiessen <- st_read("/vsizip/hydraulic_model_data/stanislaus_srh2d_2013/StanMesh072313_Thiessen.shp.zip", as_tibble=T) |>
  #mutate(vid = row_number()) # row order doesn't match the SRH2D outputs so need to spatial join
  st_join(stan_vertices, join=st_nearest_feature) |>
  select(vid) |>
  arrange(vid)
# confirm correct join via:
# ggplot() + geom_sf(data=stan_thiessen|>filter(vid<50)) + geom_sf(data=stan_vertices|>filter(vid<50)) 

# Bed elevations, extracted from mesh using QGIS "Export time series values from points of a mesh dataset"
stan_elev <- read_csv("hydraulic_model_data/stanislaus_srh2d_2013/StanMesh072313_BedElevation.csv.gz") |>
  janitor::clean_names() |>
  mutate(vid = row_number()) |>
  select(vid, bed_elevation)

# Material Manning coefficients, extracted from SRH2D DAT files for runs
stan_material_n <-
  read_delim("hydraulic_model_data/stanislaus_srh2d_2013/manning_coef.txt", delim="\t", col_names=c("manning_coef")) |>
  mutate(material_id = row_number())

# Material IDs (Manning's roughness classes) extracted from mesh using QGIS "Export time series values from points of a mesh dataset"
stan_material <- 
  read_csv("hydraulic_model_data/stanislaus_srh2d_2013/StanMesh072313_MaterialID.csv.gz") |>
  janitor::clean_names() |>
  mutate(vid = row_number()) |>
  select(vid, material_id) |>
  left_join(stan_material_n)

# alternate approach with spatial join yields the same result
# stan_material <- 
#   read_csv("hydraulic_model_data/stanislaus_srh2d_2013/StanMesh072313_MaterialID.csv.gz") |>
#   janitor::clean_names() |>
#   st_as_sf(coords=c("x","y"), crs=st_crs(stan_thiessen)) |>
#   st_join(stan_thiessen, join=st_nearest_feature)

# SRH2D results by vertex point, incl. depth, velocity, shear stress, froude
stan_result_filenames <- c(
   "500" = "hydraulic_model_data/stanislaus_srh2d_2013/500cfs_072313.csv.gz",
   "750" = "hydraulic_model_data/stanislaus_srh2d_2013/750cfs_072413.csv.gz",
  "1000" = "hydraulic_model_data/stanislaus_srh2d_2013/1000cfs_072413.csv.gz",
  "1250" = "hydraulic_model_data/stanislaus_srh2d_2013/1250cfs_090313.csv.gz",
  "1500" = "hydraulic_model_data/stanislaus_srh2d_2013/1500cfs_071013.csv.gz",
  "1750" = "hydraulic_model_data/stanislaus_srh2d_2013/1750cfs_090313.csv.gz",
  "2250" = "hydraulic_model_data/stanislaus_srh2d_2013/2250cfs_121713.csv.gz",
  "3000" = "hydraulic_model_data/stanislaus_srh2d_2013/3000cfs_061913.csv.gz",
  "5000" = "hydraulic_model_data/stanislaus_srh2d_2013/5000cfs_071113.csv.gz"
)
stan_result_cols <- c("x_m"="n", "y_m"="n", "z_m"="n", 
                      "wse_m"="n", "wdepth_m"="n", 
                      "vel_x"="n", "vel_y"="n", "vel_mag"="n", 
                      "froude"="n", "stress"="n")

stan_result <- 
  names(stan_result_filenames) |>
  lapply(function(x) read_csv(stan_result_filenames[x], col_names=names(stan_result_cols), col_types=stan_result_cols, skip=1) |> 
           mutate(discharge_cfs = as.numeric(x), vid=row_number())) |>
  bind_rows() |>
  mutate(across(everything(), function(x) if_else(x==-999,NA,x))) |>
  mutate(depth_ft = wdepth_m*3.28084, velocity_fps = vel_mag*3.28084) |>
  select(discharge_cfs, vid, depth_ft, velocity_fps) |>
  left_join(stan_elev, by=join_by(vid)) |> 
  left_join(stan_material, by=join_by(vid)) |>
  mutate(
    cover_hs = 1, # cover habitat suitability, for now, actually need to get it from stan_material
    hsi_simp = dvhsi(depth_ft, velocity_fps, method=0) * cover_hs,
    hsi_frac = dvhsi(depth_ft, velocity_fps, method=1) * cover_hs,
  ) |>
  glimpse()

```

```{r fig.width=15, fig.height=10, dpi=300, eval=FALSE, include=FALSE}
# confirm that using row order is equivalent to spatial joining
read_csv("hydraulic_model_data/stanislaus_srh2d_2013/StanMesh072313_MaterialID.csv.gz") |>
  janitor::clean_names() |>
  mutate(vid = row_number()) |>
  st_as_sf(coords = c("x","y")) |>
  ggplot() + geom_sf(aes(color=factor(material_id)), size=1) + theme(legend.position = "top")
```

```{r fig.width=15, fig.height=10, dpi=300, eval=FALSE, include=FALSE}
stan_vertices |> left_join(stan_material) |> 
  ggplot() + geom_sf(aes(color=factor(material_id)), size=1) + theme(legend.position = "top")
```

Import polygons created for each COMID reach, and calculate suitable area for each

Proof of concept, first comid, 500 cfs:
```{r stan-test}
test <- stan_thiessen |> 
  left_join(filter(stan_result, discharge_cfs==500), by=join_by(vid)) |>
  st_intersection(stan_comid[1]) |>
    mutate(area_m2 = units::drop_units(st_area(geometry)),
           wua_simp = hsi_simp * area_m2,
           wua_frac = hsi_frac * area_m2) |>
  glimpse()

#test |> ggplot() + geom_sf(aes(fill=hsi_simp), color=NA)
```

Batch process, saving flow-to-suitable-area (fsa) by comid to file

```{r stan-calc-hsi}
stan_calc_hsi <- function(g, q){
  stan_thiessen |>
    left_join(filter(stan_result, discharge_cfs==q), by=join_by(vid)) |> 
    st_intersection(g) |>
    mutate(area_m2 = units::drop_units(st_area(geometry)),
           wua_simp = hsi_simp * area_m2,
           wua_frac = hsi_frac * area_m2) |>
    summarize(area_m2 = sum(area_m2),
              wua_simp = sum(wua_simp),
              wua_frac = sum(wua_frac)) |>
    mutate(pcthab_simp = wua_simp / area_m2,
           pcthab_frac = wua_frac / area_m2) |>
    st_drop_geometry()
}

if(!file.exists("../data/fsa_stanislaus.Rds")) {
  fsa_stanislaus <- 
    stan_comid |>
    expand_grid(flow_cfs = as.numeric(names(stan_result_filenames))) |>
    mutate(result = map2(geometry, flow_cfs, function(g, q) stan_calc_hsi(st_sfc(g, crs=st_crs(stan_comid)), q))) |>
    unnest_wider(result) |>
    st_as_sf() |>
    glimpse()
  fsa_stanislaus |> saveRDS("../data/fsa_stanislaus.Rds")
} else {
  fsa_stanislaus <- readRDS("../data/fsa_stanislaus.Rds") |> glimpse()
}

#stan_hsi |> ggplot() + geom_sf(aes(fill=pcthab_simp), color=NA) + facet_wrap(~discharge_cfs)
```

```{r stan-plot-hsi, fig.width=6.5, fig.height=4, dpi=300}
fsa_stanislaus |> ggplot() + geom_line(aes(x = flow_cfs, y = pcthab_frac, color=factor(comid))) 
```

Edit: need to modify pcthab so that denominator is not area of comid, but *inundated* area

## Deer Creek

Import 2018 HEC-RAS 2D model outputs for Deer Creek

```{r}
# get land cover data
dir.create("temp/deer_land_cover", recursive = TRUE)
drive_file_by_id("1OMJzuVoFdt1hygfMVPWrQBGr2BIuxSZj") |>
  archive::archive_extract(dir="temp/deer_land_cover")
deer_lcc <- terra::rast("temp/deer_land_cover/existing_landcover_20181109.tif")
ggplot() + tidyterra::geom_spatraster(data=deer_lcc)
```

```{r}
# get 
dir.create("temp/deer_model_output", recursive = TRUE)
#drive_file_by_id("XXXXX", dir="temp/deer_model_output") |>
#"temp/deer_model_output/Existing_Habitat.7z" |> 
#  archive::archive_extract(dir="temp/deer_model_output")
  
filenames <- tribble(~flow_cfs, ~timestep,
        100, "15NOV2018 06 00 00",
        250, "15NOV2018 16 00 00",
        300, "16NOV2018 02 00 00",
        400, "16NOV2018 12 00 00",
        500, "16NOV2018 22 00 00",
        600, "17NOV2018 08 00 00",
       1000, "17NOV2018 18 00 00",
       3000, "18NOV2018 04 00 00",
       5000, "18NOV2018 14 00 00",
       6000, "19NOV2018 00 00 00",
       7000, "19NOV2018 10 00 00",
       9000, "19NOV2018 20 00 00",
      10000, "20NOV2018 06 00 00",
      11000, "20NOV2018 16 00 00",
      12000, "21NOV2018 02 00 00",
      13000, "21NOV2018 12 00 00",
      14000, "21NOV2018 22 00 00",
      15000, "22NOV2018 08 00 00") |>
  mutate(depth = paste0("temp/deer_model_output/Depth (",timestep,").vrt"),
         velocity = paste0("temp/deer_model_output/Velocity (",timestep,").vrt"))

dep_r <- terra::rast(filenames$depth)
terra::set.names(dep_r, filenames$flow_cfs)

vel_r <- terra::rast(filenames$velocity)
terra::set.names(vel_r, filenames$flow_cfs)

# STARS VERSION

dep_s <- dep_r |> 
  st_as_stars() |> 
  st_set_dimensions(3, names="flow") |>
  setNames("depth")

vel_s <- vel_r |> 
  st_as_stars() |> 
  st_set_dimensions(3, names="flow") |>
  setNames("velocity")

#deer_dep_vel <- c(dep_s, vel_s)
# raster_hsi <- function(q) {
#   d <- dep_s[,,,q]
#   v <- vel_s[,,,q]
#   #...
# }

# TERRA VERSION

deer_comids <- 
  st_read("/vsizip/hydraulic_model_data/deercreek_hecras2d_2018/model_perim_split_comid_generalized.shp.zip", as_tibble=T) |>
  janitor::clean_names() |> filter(comid>0)

raster_hsi <- function(g, q, crs=st_crs(deer_comids)){
  comid <- terra::vect(st_sfc(g, crs=crs))
  d <- dep_r[[as.character(q)]] |> terra::crop(comid) 
  v <- vel_r[[as.character(q)]] |> terra::crop(comid) 
  ext <- (d>0)
  hsi <- (d>0.5 & d<=5.2) & (v>0.1 & v<=4.0)
  area_wua <- terra::global(hsi, "sum", na.rm=TRUE)
  area_tot <- terra::global(ext, "sum", na.rm=TRUE)
  area_pct <- area_wua / area_tot
  return(list("ext"=ext, 
              "hsi"=hsi, 
              "area_tot"=area_tot, 
              "area_wua"=area_wua, 
              "area_pct"=area_pct))
}

# test
comid <- deer_comids$geometry[[1]]
q <- 500
out <- raster_hsi(comid, q)

#batch
deer_hsi_result <- 
  deer_comids |> 
  expand_grid(flow_cfs=filenames$flow_cfs) |>
  mutate(result = pmap(list(geometry, flow_cfs), raster_hsi)) |>
  unnest_wider(result)

#result |> terra::writeRaster("temp/deer_creek_hsi.tif")

```

```{r}
# examples
dep |> plot() 

dep |>
  filter(flow==500) |>
  mutate(suitable=if_else(depth>0.5 & depth<=5.2,1,0)) |>
  select(suitable) |>
  plot()
```
